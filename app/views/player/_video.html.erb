<%# TODO: figure out how to programmatically set height with JavaScript, or something %>
<%# should match app/assets/stylesheets/application.scss %>
<video width="100%" height="270" class="mejs__player" preload="<%= preload %>" controls>
  <%# TODO: clean this up, separate partials, something %>
  <% if browser.platform.ios? || browser.device.ipad? %>
    <% source_id = "source-hls-#{index}" %>
    <source id="<%= source_id %>" src="<%= track.hls_uri %>" type="<%= AV::Track::SOURCE_TYPE_HLS %>"/>
  <% else %>
    <% source_id = "source-dash-#{index}" %>
    <source id="<%= source_id %>" src="<%= track.mpeg_dash_uri %>" type="<%= AV::Track::SOURCE_TYPE_MPEG_DASH %>"/>

    <%# EZProxy shenanigans - TODO: clean up / share code%>
    <%= javascript_tag do -%>
      src_id = '#<%= source_id %>'
      src_orig = $(src_id).attr('src');
      src_safe = src_orig.replace(/vm147-lib-berkeley-edu\.libproxy.*\.berkeley\.edu/, 'vm147.lib.berkeley.edu');
      $(src_id).attr('src', src_safe);
    <% end -%>

    <% if (dash_vtt_uri = track.dash_vtt_uri) %>
      <% caption_track_id = "captions-dash-#{index}" %>
      <track default kind="captions" srclang="en" src="<%= dash_vtt_uri %>"/>

      <%# EZProxy shenanigans - TODO: clean up / share code%>
      <%= javascript_tag do -%>
        src_id = '#<%= caption_track_id %>'
        src_orig = $(src_id).attr('src');
        src_safe = src_orig.replace(/vm147-lib-berkeley-edu\.libproxy.*\.berkeley\.edu/, 'vm147.lib.berkeley.edu');
        $(src_id).attr('src', src_safe);
      <% end -%>
    <% end %>
  <% end %>
</video>
